From 9039a12662a6d09aefcbc6e3c8d8629ae15a3ba5 Mon Sep 17 00:00:00 2001
From: Jani Hautakangas <jani@igalia.com>
Date: Mon, 23 Sep 2024 13:51:10 +0300
Subject: Compile WebDriver as a library.

---
 Source/WebDriver/CMakeLists.txt    | 4 ++--
 Source/WebDriver/WebDriverMain.cpp | 7 ++++++-
 Source/cmake/WebKitCommon.cmake    | 1 +
 3 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/Source/WebDriver/CMakeLists.txt b/Source/WebDriver/CMakeLists.txt
index e02335591d3d..7bb637e1d99c 100644
--- a/Source/WebDriver/CMakeLists.txt
+++ b/Source/WebDriver/CMakeLists.txt
@@ -66,13 +66,13 @@ MAKE_JS_FILE_ARRAYS(
 )
 list(APPEND WebDriver_SOURCES ${WebDriver_DERIVED_SOURCES_DIR}/WebDriverAtoms.cpp)
 
-WEBKIT_EXECUTABLE_DECLARE(WebDriver)
+WEBKIT_LIBRARY_DECLARE(WebDriver)
 
 add_dependencies(WebDriver JavaScriptCoreSharedScripts)
 
 WEBKIT_INCLUDE_CONFIG_FILES_IF_EXISTS()
 
-WEBKIT_EXECUTABLE(WebDriver)
+WEBKIT_LIBRARY(WebDriver)
 
 install(TARGETS WebDriver
     RUNTIME DESTINATION "${EXEC_INSTALL_DIR}"
diff --git a/Source/WebDriver/WebDriverMain.cpp b/Source/WebDriver/WebDriverMain.cpp
index bdefb9913c1a..58c4dc2e5295 100644
--- a/Source/WebDriver/WebDriverMain.cpp
+++ b/Source/WebDriver/WebDriverMain.cpp
@@ -30,7 +30,10 @@
 #include <wtf/MainThread.h>
 #include <wtf/Threading.h>
 
-int main(int argc, char** argv)
+extern "C" {
+
+__attribute__((visibility("default")))
+int android_WebDriverProcess_main(int argc, char** argv)
 {
     WebDriver::WebDriverService::platformInit();
 
@@ -42,3 +45,5 @@ int main(int argc, char** argv)
     WebDriver::WebDriverService service;
     return service.run(argc, argv);
 }
+
+}
diff --git a/Source/cmake/WebKitCommon.cmake b/Source/cmake/WebKitCommon.cmake
index 38ac0c471add..359906540cc8 100644
--- a/Source/cmake/WebKitCommon.cmake
+++ b/Source/cmake/WebKitCommon.cmake
@@ -166,6 +166,7 @@ if (NOT HAS_RUN_WEBKIT_COMMON)
     set(WebKitLegacy_LIBRARY_TYPE SHARED)
     set(WebKit_LIBRARY_TYPE SHARED)
     set(WebCoreTestSupport_LIBRARY_TYPE STATIC)
+    set(WebDriver_LIBRARY_TYPE SHARED)
 
     set(CMAKE_POSITION_INDEPENDENT_CODE True)
 
-- 
2.49.0


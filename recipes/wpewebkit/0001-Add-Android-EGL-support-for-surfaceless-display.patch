From 49a2683a735fd196e6b4729364eed7936bf84649 Mon Sep 17 00:00:00 2001
From: Felipe Erias <felipeerias@igalia.com>
Date: Tue, 14 Oct 2025 14:29:37 +0900
Subject: [PATCH] Add Android EGL support for surfaceless display

Enable PlatformDisplaySurfaceless on Android by adding fallback to
EGL_DEFAULT_DISPLAY when EGL_MESA_platform_surfaceless is not available.

This allows WebProcess to initialize on Android devices which don't
support the MESA-specific EGL extensions.
---
 .../egl/PlatformDisplaySurfaceless.cpp        | 21 +++++++++++++------
 1 file changed, 15 insertions(+), 6 deletions(-)

diff --git a/Source/WebCore/platform/graphics/egl/PlatformDisplaySurfaceless.cpp b/Source/WebCore/platform/graphics/egl/PlatformDisplaySurfaceless.cpp
index 27e4b960..8d317e38 100644
--- a/Source/WebCore/platform/graphics/egl/PlatformDisplaySurfaceless.cpp
+++ b/Source/WebCore/platform/graphics/egl/PlatformDisplaySurfaceless.cpp
@@ -34,14 +34,23 @@ namespace WebCore {
 std::unique_ptr<PlatformDisplaySurfaceless> PlatformDisplaySurfaceless::create()
 {
     const char* extensions = eglQueryString(nullptr, EGL_EXTENSIONS);
-    if (!GLContext::isExtensionSupported(extensions, "EGL_MESA_platform_surfaceless"))
-        return nullptr;
 
     RefPtr<GLDisplay> glDisplay;
-    if (GLContext::isExtensionSupported(extensions, "EGL_EXT_platform_base"))
-        glDisplay = GLDisplay::create(eglGetPlatformDisplayEXT(EGL_PLATFORM_SURFACELESS_MESA, EGL_DEFAULT_DISPLAY, nullptr));
-    else if (GLContext::isExtensionSupported(extensions, "EGL_KHR_platform_base"))
-        glDisplay = GLDisplay::create(eglGetPlatformDisplay(EGL_PLATFORM_SURFACELESS_MESA, EGL_DEFAULT_DISPLAY, nullptr));
+
+    // Try Mesa surfaceless platform extension (Linux desktop with Mesa)
+    if (GLContext::isExtensionSupported(extensions, "EGL_MESA_platform_surfaceless")) {
+        if (GLContext::isExtensionSupported(extensions, "EGL_EXT_platform_base"))
+            glDisplay = GLDisplay::create(eglGetPlatformDisplayEXT(EGL_PLATFORM_SURFACELESS_MESA, EGL_DEFAULT_DISPLAY, nullptr));
+        else if (GLContext::isExtensionSupported(extensions, "EGL_KHR_platform_base"))
+            glDisplay = GLDisplay::create(eglGetPlatformDisplay(EGL_PLATFORM_SURFACELESS_MESA, EGL_DEFAULT_DISPLAY, nullptr));
+    }
+
+    // Fallback: Use standard EGL_DEFAULT_DISPLAY (Android, embedded systems)
+    if (!glDisplay) {
+        EGLDisplay display = eglGetDisplay(EGL_DEFAULT_DISPLAY);
+        if (display != EGL_NO_DISPLAY)
+            glDisplay = GLDisplay::create(display);
+    }
 
     if (!glDisplay) {
         WTFLogAlways("Could not create surfaceless EGL display: %s. Aborting...", GLContext::lastErrorString());
-- 
2.43.0


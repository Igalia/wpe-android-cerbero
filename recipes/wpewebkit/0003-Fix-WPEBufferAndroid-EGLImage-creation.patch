From 468d5b0cf5b923caf656c0a39c283f45602a4146 Mon Sep 17 00:00:00 2001
From: Felipe Erias <felipeerias@igalia.com>
Date: Tue, 14 Oct 2025 21:26:32 +0900
Subject: [PATCH] Fix WPEBufferAndroid EGLImage creation on Android

Fix EGLImage creation from AHardwareBuffer by properly using the
eglGetNativeClientBufferANDROID() function as required by Android/EGL
documentation, instead of directly casting AHardwareBuffer pointers
to EGLClientBuffer.

According to the Android hardware_buffer.h documentation:
"For EGL, use the extension function eglGetNativeClientBufferANDROID
to obtain an EGLClientBuffer and pass it directly to eglCreateImageKHR."

This fixes the "Failed to create EGLImage from AHardwareBuffer" error
that prevents hardware-accelerated rendering on Android.

Changes:
- Update createImageEGL15() to convert AHardwareBuffer to EGLClientBuffer
- Update createImageKHRImageBase() to convert AHardwareBuffer to EGLClientBuffer
- Add proper null checks for EGLClientBuffer conversion
---
 Source/WebKit/WPEPlatform/wpe/WPEBufferAndroid.cpp | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/Source/WebKit/WPEPlatform/wpe/WPEBufferAndroid.cpp b/Source/WebKit/WPEPlatform/wpe/WPEBufferAndroid.cpp
index 06a37c1c..03fe202b 100644
--- a/Source/WebKit/WPEPlatform/wpe/WPEBufferAndroid.cpp
+++ b/Source/WebKit/WPEPlatform/wpe/WPEBufferAndroid.cpp
@@ -51,14 +51,24 @@ static PFNEGLCREATEIMAGEPROC s_eglCreateImage = nullptr;
 
 static EGLImage createImageEGL15(EGLDisplay display, AHardwareBuffer * ahb)
 {
+    // Convert AHardwareBuffer to EGLClientBuffer using the Android extension
+    EGLClientBuffer clientBuffer = eglGetNativeClientBufferANDROID(ahb);
+    if (!clientBuffer)
+        return EGL_NO_IMAGE;
+
     static constexpr std::array<EGLAttrib, 3> attributes = { EGL_IMAGE_PRESERVED, EGL_TRUE, EGL_NONE };
-    return s_eglCreateImage(display, EGL_NO_CONTEXT, EGL_NATIVE_BUFFER_ANDROID, ahb, attributes.data());
+    return s_eglCreateImage(display, EGL_NO_CONTEXT, EGL_NATIVE_BUFFER_ANDROID, clientBuffer, attributes.data());
 }
 
 static EGLImage createImageKHRImageBase(EGLDisplay display, AHardwareBuffer* ahb)
 {
+    // Convert AHardwareBuffer to EGLClientBuffer using the Android extension
+    EGLClientBuffer clientBuffer = eglGetNativeClientBufferANDROID(ahb);
+    if (!clientBuffer)
+        return EGL_NO_IMAGE;
+
     static constexpr std::array<EGLint, 3> attributes = { EGL_IMAGE_PRESERVED, EGL_TRUE, EGL_NONE };
-    return s_eglCreateImageKHR(display, EGL_NO_CONTEXT, EGL_NATIVE_BUFFER_ANDROID, ahb, attributes.data());
+    return s_eglCreateImageKHR(display, EGL_NO_CONTEXT, EGL_NATIVE_BUFFER_ANDROID, clientBuffer, attributes.data());
 }
 
 static void wpeBufferAndroidDisposeEGLImageIfNeeded(WPEBufferAndroid* androidBuffer)
-- 
2.43.0

